---
title: "Klimaxan_report"
authors: 
date: "2026-01-18"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages(library(tidyverse))
library(readxl)
library(readr)
library(flextable)
library(knitr)
library(gtsummary)

set_flextable_defaults(table.layout = "autofit",
                       font.family = "Times New Roman")

flex_default_fun <- function(x) {
  x %>% 
  theme_box() %>%
  font(fontname = "Times New Roman", part = "all") %>% 
  fontsize(size = 13, part = "header") %>% 
  fontsize(size = 12, part = "body") %>% 
  flextable::align(
  i = 1,
  j = NULL,
  align = "center",
  part = "header")
}

statistics <- list(
        "N valid" = ~round(sum(!is.na(.)), 2),
        # "Пропущенные значения, n" = ~round(sum(is.na(.)), 2),
        "Среднее" = ~round(mean(., na.rm = TRUE), 2),
        "Стандартное отклонение"   = ~round(sd(., na.rm = TRUE), 2),
        "Медиана" = ~round(median(., na.rm = TRUE), 2),
        "Q1" = ~round(quantile(., 0.25, na.rm = TRUE), 2),
        "Q3" = ~round(quantile(., 0.75, na.rm = TRUE), 2),
        "IQR" = ~round(IQR(., na.rm = TRUE), 2),
        "Мин"  = ~round(min(., na.rm = TRUE), 2),
        "Макс"  = ~round(max(., na.rm = TRUE), 2)
      )

```



```{r data load}

data_raw <- read_csv("team5_ecrf_wide.csv")
glimpse(data_raw)

```



``` {r data prep, echo=FALSE}
data_transformed <- data_raw %>%
  mutate(
    across(8:38, as.factor)
    )


    
    
    
    
data_long <- data_raw %>%
  pivot_longer(
    cols = matches("^V[0-9]+_"),
    names_to = "var",
    values_to = "value"
  ) %>%
  mutate(
    visit = str_extract(var, "^V[0-9]+"),
    varname = str_remove(var, "^V[0-9]+_")
  )


glimpse(data_long)
```

``` {r summary baseline tables, echo=FALSE }

baseline_df <- data_raw %>%
  mutate(
    ARM = factor(ARM)
  ) %>%
  transmute(
    ID = USUBJID,
    "Группа лечения" = ARM,
    #демография и антропометрия
    "Пол" = if_else(V0_DEM_SEX == FALSE, "Женский", "Мужской"),
    "Возраст" = V0_DEM_AGE,
    "Рост, см" = V0_ANT_HEIGHTCM,
    "Вес, кг"  = V0_ANT_WEIGHTKG,
    "ИМТ, кг/м²" = V0_ANT_BMI,
    
    #Гормоны и опросники
    "Эстрадиол (E2)" = V0_HOR_E2,
    "Фолликулостимулирующий гормон (ФСГ)" = V0_HOR_FSH,
    "Шкала Грина (баллы)" = V0_SYM_GREENE,
    "SF-36 (баллы)"       = V0_QOL_SF36,
    "Приливы (кол-во)"    = V0_SYM_FLASHES,
    
    # Витальные показатели
    "Отклонение ЧСС"   = factor(V0_VIT_HR_ABN,   levels = c(0, 1), labels = c("Нет", "Да")),
    "Отклонение ЧДД"   = factor(V0_VIT_RR_ABN,   levels = c(0, 1), labels = c("Нет", "Да")),
    "Отклонение АД"    = factor(V0_VIT_BP_ABN,   levels = c(0, 1), labels = c("Нет", "Да")),
    "Отклонение температуры"  = factor(V0_VIT_TEMP_ABN, levels = c(0, 1), labels = c("Нет", "Да")),
    
    # ЭКГ
    "Нарушение ритма" = factor(V0_ECG_RHYTHM_ABN, levels = c(0, 1), labels = c("Нет", "Да")),
    "Изменения ST-T"  = factor(V0_ECG_STT_ABN,    levels = c(0, 1), labels = c("Нет", "Да")),
    "QT-аномалия"     = factor(V0_ECG_QT_ABN,     levels = c(0, 1), labels = c("Нет", "Да")),
    
    #Клинический анализ крови
    "Гемоглобин"   = V0_CBC_HGB,
    "Лейкоциты"   = V0_CBC_WBC,
    "Тромбоциты"   = V0_CBC_PLT,
    
    #Биохимия
    "Креатинин" = V0_BIO_CREAT,
    "АЛТ"   = V0_BIO_ALT,
    "АСТ"  = V0_BIO_AST,
    "Холестерин общий"  = V0_BIO_CHOL,
    "Гликированный гемоглобин (HbA1c)" = V0_BIO_HBA1C,
    
    # Общий анализ мочи 
    "Белок" = V0_URN_PROT,
    "Эритроциты" = V0_URN_RBC
  )


make_section_ft <- function(df, vars, title) {
  df %>%
    select(`Группа лечения`, all_of(vars)) %>%
    tbl_summary(
      by = `Группа лечения`,
      statistic = list(
        all_continuous() ~ "\n{mean} ± {sd}\n{median} [{p25}, {p75}]",
        all_categorical() ~ "{n} ({p}%)"
      ),
      digits = all_continuous() ~ 2,
      missing = "ifany"
    ) %>%
    add_p(
      test = list(
        all_continuous() ~ "t.test",      
        all_categorical() ~ "chisq.test"  
      )
    ) %>%
    modify_header(label ~ "**Показатель**") %>%
    modify_spanning_header(all_stat_cols() ~ "**Группа лечения**") %>%
    modify_caption(title) %>% 
    as_flex_table() %>% 
    autofit() %>%
    flextable::set_caption(caption = title)
}



baseline_table_1 <- make_section_ft (baseline_df, c( "Возраст", "Рост, см", "Вес, кг", "ИМТ, кг/м²"), "Таблица 1. Демография и антропометрия")
baseline_table_2 <- make_section_ft (baseline_df, c("Эстрадиол (E2)", "Фолликулостимулирующий гормон (ФСГ)", "Шкала Грина (баллы)", "SF-36 (баллы)", "Приливы (кол-во)"),
                       "Таблица 2. Гормоны, симптомы и качество жизни")
baseline_table_3 <- make_section_ft (baseline_df, c("Креатинин", "АЛТ", "АСТ", "Холестерин общий", "Гликированный гемоглобин (HbA1c)"), "Таблица 3. Биохимия крови")
baseline_table_4 <- make_section_ft (baseline_df, c("Белок", "Эритроциты"), "Таблица 4. Показатели мочи")
baseline_table_5 <- make_section_ft (baseline_df, c("Отклонение ЧСС", "Отклонение ЧДД", "Отклонение АД", "Отклонение температуры"), "Таблица 5. Витальные показатели")
baseline_table_6 <- make_section_ft (baseline_df, c("Нарушение ритма", "Изменения ST-T", "QT-аномалия"), "Таблица 6. ЭКГ")
baseline_table_7 <- make_section_ft (baseline_df, c("Гемоглобин", "Лейкоциты", "Тромбоциты"), "Таблица 7. Клинический анализ крови")
```
