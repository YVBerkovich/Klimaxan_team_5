---
title: "Статистический отчёт по результатам клинического исследования III фазы по изучению эффективности и безопасности Климаксана"
authors: "Беркович Ян, Гордеев Алексей, Смородина Жанна, Тимкина Наталья"
date: "2026-01-18"
output:
  officedown::rdocx_document:
    reference_docx: "example.docx"
    toc: true
    toc_depth: 8
toc-title: "Оглавление"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(readr)
library(flextable)
library(survival)
library(knitr)
library(gtsummary)

set_flextable_defaults(table.layout = "autofit",
                       font.family = "Times New Roman")

flex_default_fun <- function(x) {
  x %>% 
  theme_box() %>%
  font(fontname = "Times New Roman", part = "all") %>% 
  fontsize(size = 13, part = "header") %>% 
  fontsize(size = 12, part = "body") %>% 
  flextable::align(
  i = 1,
  j = NULL,
  align = "center",
  part = "header")
}

statistics <- list(
        "N valid" = ~round(sum(!is.na(.)), 0),
        # "Пропущенные значения, n" = ~round(sum(is.na(.)), 2),
        "Среднее" = ~round(mean(., na.rm = TRUE), 2),
        "Стандартное отклонение"   = ~round(sd(., na.rm = TRUE), 2),
        "Медиана" = ~round(median(., na.rm = TRUE), 2),
        "Q1" = ~round(quantile(., 0.25, na.rm = TRUE), 2),
        "Q3" = ~round(quantile(., 0.75, na.rm = TRUE), 2),
        "IQR" = ~round(IQR(., na.rm = TRUE), 2),
        "Мин"  = ~round(min(., na.rm = TRUE), 2),
        "Макс"  = ~round(max(., na.rm = TRUE), 2)
      )

```


```{r read-data, message=FALSE}
data_raw <- read_csv("team5_ecrf_wide.csv")
```


``` {r data prep, echo=FALSE}
data_transformed <- data_raw %>%
  mutate(
    across(8:38, as.factor)
    )
data_long <- data_raw %>%
  pivot_longer(
    cols = matches("^V[0-9]+_"),
    names_to = "var",
    values_to = "value"
  ) %>%
  mutate(
    visit = str_extract(var, "^V[0-9]+"),
    varname = str_remove(var, "^V[0-9]+_")
  )

```

# Раздел 1.  Демографические, антроп. данные и исходные характеристики заболевания 

``` {r summary baseline tables, echo=FALSE }
baseline_df <- data_raw %>%
  mutate(
    ARM = case_when(
      ARM == "Angelique" ~ "Анжелик",
      ARM == "Climaksan" ~ "Климаксан"
    ) %>% factor()
  ) %>%
  transmute(
    ID = USUBJID,
    "Группа лечения" = ARM,
    #демография и антропометрия
    "Пол" = if_else(V0_DEM_SEX == FALSE, "Женский", "Мужской"),
    "Возраст" = V0_DEM_AGE,
    "Рост, см" = V0_ANT_HEIGHTCM,
    "Вес, кг"  = V0_ANT_WEIGHTKG,
    "ИМТ, кг/м²" = V0_ANT_BMI,
    
    #Гормоны и опросники
    "Эстрадиол (E2)" = V0_HOR_E2,
    "Фолликулостимулирующий гормон (ФСГ)" = V0_HOR_FSH,
    "Шкала Грина (баллы)" = V0_SYM_GREENE,
    "SF-36 (баллы)"       = V0_QOL_SF36,
    "Приливы (кол-во)"    = V0_SYM_FLASHES,
    
    # Витальные показатели
    "Отклонение ЧСС"   = factor(V0_VIT_HR_ABN,   levels = c(0, 1), labels = c("Нет", "Да")),
    "Отклонение ЧДД"   = factor(V0_VIT_RR_ABN,   levels = c(0, 1), labels = c("Нет", "Да")),
    "Отклонение АД"    = factor(V0_VIT_BP_ABN,   levels = c(0, 1), labels = c("Нет", "Да")),
    "Отклонение температуры"  = factor(V0_VIT_TEMP_ABN, levels = c(0, 1), labels = c("Нет", "Да")),
    
    # ЭКГ
    "Нарушение ритма" = factor(V0_ECG_RHYTHM_ABN, levels = c(0, 1), labels = c("Нет", "Да")),
    "Изменения ST-T"  = factor(V0_ECG_STT_ABN,    levels = c(0, 1), labels = c("Нет", "Да")),
    "QT-аномалия"     = factor(V0_ECG_QT_ABN,     levels = c(0, 1), labels = c("Нет", "Да")),
    
    #Клинический анализ крови
    "Гемоглобин"   = V0_CBC_HGB,
    "Лейкоциты"   = V0_CBC_WBC,
    "Тромбоциты"   = V0_CBC_PLT,
    
    #Биохимия
    "Креатинин" = V0_BIO_CREAT,
    "АЛТ"   = V0_BIO_ALT,
    "АСТ"  = V0_BIO_AST,
    "Холестерин общий"  = V0_BIO_CHOL,
    "Гликированный гемоглобин (HbA1c)" = V0_BIO_HBA1C,
    
    # Общий анализ мочи 
    "Белок" = V0_URN_PROT,
    "Эритроциты" = V0_URN_RBC
  )


make_section_ft <- function(df, vars, title) {
  df %>%
    select(`Группа лечения`, all_of(vars)) %>%
    tbl_summary(
      by = `Группа лечения`,
      statistic = list(
        all_continuous() ~ "\n{mean} ± {sd}\n{median} [{p25}, {p75}]",
        all_categorical() ~ "{n} ({p}%)"
      ),
      digits = all_continuous() ~ 2,
      missing = "ifany"
    ) %>%
    add_p(
      test = list(
        all_continuous() ~ "t.test",      
        all_categorical() ~ "chisq.test"  
      )
    ) %>%
    modify_header(label ~ "**Показатель**") %>%
    modify_spanning_header(all_stat_cols() ~ "**Группа лечения**") %>%
    modify_caption(title) %>% 
    as_flex_table() %>% 
    autofit() %>%
    flextable::set_caption(caption = title)
}


baseline_table_1 <- make_section_ft (baseline_df, c( "Возраст", "Рост, см", "Вес, кг", "ИМТ, кг/м²"), "Таблица 1. Демография и антропометрия")
baseline_table_2 <- make_section_ft (baseline_df, c("Эстрадиол (E2)", "Фолликулостимулирующий гормон (ФСГ)", "Шкала Грина (баллы)", "SF-36 (баллы)", "Приливы (кол-во)"),
                       "Таблица 2. Гормоны, симптомы и качество жизни")
baseline_table_3 <- make_section_ft (baseline_df, c("Креатинин", "АЛТ", "АСТ", "Холестерин общий", "Гликированный гемоглобин (HbA1c)"), "Таблица 3. Биохимия крови")
baseline_table_4 <- make_section_ft (baseline_df, c("Белок", "Эритроциты"), "Таблица 4. Показатели мочи")
baseline_table_5 <- make_section_ft (baseline_df, c("Отклонение ЧСС", "Отклонение ЧДД", "Отклонение АД", "Отклонение температуры"), "Таблица 5. Витальные показатели")
baseline_table_6 <- make_section_ft (baseline_df, c("Нарушение ритма", "Изменения ST-T", "QT-аномалия"), "Таблица 6. ЭКГ")
baseline_table_7 <- make_section_ft (baseline_df, c("Гемоглобин", "Лейкоциты", "Тромбоциты"), "Таблица 7. Клинический анализ крови")
```


```{r print baseline tables, echo=FALSE}
baseline_table_1
baseline_table_2
baseline_table_3
baseline_table_4
baseline_table_5
baseline_table_6
baseline_table_7
```

# Раздел 3. Анализ конечных точек

## Раздел 3.1 Анализ первичной конечной точки

Считаем уменьшение приливов к последнему визиту по сравнению с базовым уровнем.

```{r primary 1, echo=FALSE}
data_raw <- data_raw %>%
  mutate(delta_f = V0_SYM_FLASHES - V7_SYM_FLASHES)
```

*Сводная таблица *

```{r primary 2, echo=FALSE}
data_raw <- data_raw %>% 
  mutate(ARM = ARM %>% as.factor() %>% forcats::fct_rev())

desc_stats <- data_raw %>%
  group_by(ARM) %>%
  summarise(
    n = sum(!is.na(delta_f)),
    mean_delta = mean(delta_f, na.rm = TRUE),
    sd_delta = sd(delta_f, na.rm = TRUE),
    se_delta = sd_delta / sqrt(n),
    ci_lower = mean_delta - qt(0.975, n-1) * se_delta,
    ci_upper = mean_delta + qt(0.975, n-1) * se_delta,
    median_delta = median(delta_f, na.rm = TRUE),
    min_delta = min(delta_f, na.rm = TRUE),
    max_delta = max(delta_f, na.rm = TRUE)
  ) %>% 
  mutate(n = n %>% round(0),
         across(c(where(is.numeric), -n), ~round(.x, 2)))

desc_stats %>% 
  flextable() %>%
  flex_default_fun()
```



```{r primary 2-123, echo=FALSE}
non_inferiority_margin <- -2  
alpha <- 0.05  
conf_level <- 1 - alpha  

# Правильные формулировки гипотез:
# H0: μ_T - μ_R ≤ -2 (Климаксан УСТУПАЕТ Анжелику)
# H1: μ_T - μ_R > -2 (Климаксан НЕ УСТУПАЕТ Анжелику)
t_test_noninf <- t.test(delta_f ~ ARM, 
                       data = data_raw,  
                       var.equal = FALSE,
                       conf.level = conf_level / 2,  
                       alternative = "greater",  
                       mu = non_inferiority_margin)  

cat("\n=== Результаты t-теста для проверки не меньшей эффективности ===\n")
cat(sprintf("Граница не меньшей эффективности (дельта): %.2f\n", non_inferiority_margin))
cat(sprintf("Статистика t: %.3f\n", t_test_noninf$statistic))
cat(sprintf("Степени свободы: %.2f\n", t_test_noninf$parameter))
cat(sprintf("Одностороннее p-значение: %.4f\n", t_test_noninf$p.value))
cat(sprintf("95%% односторонний ДИ: [%.3f, Inf]\n", t_test_noninf$conf.int[1]))
cat(sprintf("Разность средних (Климаксан - Анжелик): %.3f\n", 
            -diff(t_test_noninf$estimate)))  

mean_diff <- -diff(t_test_noninf$estimate)
se_diff <- sqrt(sum(desc_stats$sd_delta^2 / desc_stats$n))
df_welch <- t_test_noninf$parameter
margin <- qt(1 - alpha, df_welch) * se_diff
ci_lower_noninf <- mean_diff - margin

cat(sprintf("\nТочная оценка разности: %.3f\n", mean_diff))
cat(sprintf("97.5%% односторонний ДИ (нижняя граница): %.3f\n", ci_lower_noninf))

cat("\n=== Вывод о не меньшей эффективности ===\n")
if (t_test_noninf$p.value < alpha && ci_lower_noninf > non_inferiority_margin) {
  cat("ОТВЕРГАЕМ H0: Климаксан НЕ УСТУПАЕТ Анжелику.\n")
  cat(sprintf("Нижняя граница 95%% ДИ (%.3f) > границы не меньшей эффективности (%.2f)\n", 
              ci_lower_noninf, non_inferiority_margin))
} else {
  cat("НЕ ОТВЕРГАЕМ H0: Не удалось доказать не меньшую эффективность Климаксана.\n")
  cat(sprintf("Нижняя граница 95%% ДИ (%.3f) ≤ границе не меньшей эффективности (%.2f)\n", 
              ci_lower_noninf, non_inferiority_margin))
}
```



```{r primary 3, echo=FALSE}
# cat("\n=== Двусторонний t-тест Уэлча для общего сравнения ===\n")
t_test_welch <- t.test(delta_f ~ ARM, 
                      data = data_raw,
                      var.equal = FALSE,
                      conf.level = 0.95)
t_test_welch %>% broom::tidy() %>% 
  mutate(p.value = p.value %>% gtsummary::style_pvalue()) %>%
  mutate(across(c(where(is.numeric), -p.value), ~round(.x, 2))) %>%
  mutate(across(everything(), ~as.character(.x))) %>% 
  select(-c(method, alternative)) %>% 
   rename(
    `Разница средних между гр. Климаксана и гр. Анжелика` = estimate,
    `Среднее в гр. Климаксана` = estimate1,
    `Среднее в гр. Анжелика` = estimate2,
    `t-статистика` = statistic,
    `Степени свободы` = parameter,
    `P-value` = p.value,
    `Нижн. гр. 95% ДИ` = conf.low,
    `Верхн. гр. 95% ДИ` = conf.high
  ) %>% 
  pivot_longer(everything(),
               names_to = "Параметр",
               values_to = "Значение") %>% 
  flextable() %>% 
  flex_default_fun() %>% 
  add_header_row(values = "Двусторонний t-тест Уэлча для общего сравнения",
                 colwidths = 2)
```



```{r primary 4, echo=FALSE}
density_plot <- ggplot(data_raw, aes(x = delta_f)) +
  geom_histogram(aes(y = after_stat(density), fill = ARM), 
                 alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.3, aes(fill = ARM)) +
  geom_vline(data = desc_stats, aes(xintercept = mean_delta, color = ARM),
             linetype = "dashed", linewidth = 1) +
  facet_wrap(~ARM, ncol = 1) +
  scale_fill_manual(values = c("Climaksan" = "blue", "Angelique" = "red"),
                    labels = c("Climaksan" = "Климаксан", "Angelique" = "Анжелик")) +
  scale_color_manual(values = c("Climaksan" = "darkblue", "Angelique" = "darkred"),
                    labels = c("Climaksan" = "Климаксан", "Angelique" = "Анжелик")) +
  labs(title = "Распределение изменений частоты приливов",
       x = "Изменение частоты приливов (приливы/сутки)",
       y = "Плотность распределения",
       color = "Терапия",
       fill = "Терапия",
       caption = "Пунктирная линия = среднее значение") +
  theme_minimal() +
  theme(strip.text.x = element_blank())

print(density_plot)
```



```{r primary 5, echo=FALSE}
library(ggplot2)
library(dplyr)

# Подготовка данных для графика
plot_data <- data.frame(
  Comparison = "Климаксан vs Анжелик",
  Estimate = -3.236,
  CI_lower = -3.663,
  CI_upper = -2.809,
  Margin = -2,
  p_value = 1.000
)

# Создание графика
forest_plot <- ggplot(plot_data, aes(x = Estimate, y = Comparison)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_vline(xintercept = -2, linetype = "solid", color = "red", size = 1) +
  geom_point(size = 4, color = "blue") +
  geom_errorbarh(aes(xmin = CI_lower, xmax = CI_upper), 
                 height = 0.1, size = 1, color = "blue") +
  geom_rect(aes(xmin = -Inf, xmax = -2, ymin = -Inf, ymax = Inf),
            fill = "red", alpha = 0.05) +
  annotate("text", x = -2, y = 1.2, 
           label = "Граница не меньшей эффективности\n(-2 прилива/сутки)",
           hjust = 0.5, vjust = 0, color = "red", fontface = "bold") +
  annotate("text", x = -3.236, y = 0.7, 
           label = sprintf("Разность средних: %.3f\n95%% ДИ: [%.3f; %.3f]\nP = %.4f", 
                          -3.236, -3.663, -2.809, 1.000),
           hjust = 0.5, vjust = 0.5, color = "black") +
  scale_x_continuous(breaks = seq(-5, 1, 0.5),
                     limits = c(-5, 1),
                     name = "Разность средних (Климаксан - Анжелик)\nприливы/сутки") +
  labs(title = "Анализ не меньшей эффективности",
       subtitle = "Первичная конечная точка: изменение частоты приливов",
       y = "") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.title.x = element_text(size = 11, face = "bold"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )

print(forest_plot)
```



```{r sec-end-time}
calculate_time_to_reduction_fast <- function(data) {

  visit_days <- c(0, 15, 30, 45, 60, 75, 90)

  flash_cols <- c("V0_SYM_FLASHES", "V2_SYM_FLASHES", "V3_SYM_FLASHES", 
                  "V4_SYM_FLASHES", "V5_SYM_FLASHES", "V6_SYM_FLASHES", 
                  "V7_SYM_FLASHES")
  
  results <- data_raw %>%
    mutate(
      baseline = V0_SYM_FLASHES,
      target = baseline - 2,
      reduction_day = case_when(
        !is.na(V2_SYM_FLASHES) & V2_SYM_FLASHES <= target ~ 15,
        !is.na(V3_SYM_FLASHES) & V3_SYM_FLASHES <= target ~ 30,
        !is.na(V4_SYM_FLASHES) & V4_SYM_FLASHES <= target ~ 45,
        !is.na(V5_SYM_FLASHES) & V5_SYM_FLASHES <= target ~ 60,
        !is.na(V6_SYM_FLASHES) & V6_SYM_FLASHES <= target ~ 75,
        !is.na(V7_SYM_FLASHES) & V7_SYM_FLASHES <= target ~ 90,
        TRUE ~ NA_real_
      ),
      event_status = if_else(is.na(reduction_day), 0, 1),
      
      time_to_event = if_else(
        event_status == 1,
        reduction_day,
        90
      ),
      
      time_to_event = case_when(
        is.na(baseline) | baseline < 2 ~ NA_real_,
        event_status == 1 ~ reduction_day,
        TRUE ~ 90
      )
    ) %>%
    select(-c(target, reduction_day))
  
  return(results)
}

data_with_time <- calculate_time_to_reduction_fast(data_raw)
```

## Раздел 3.2 Анализ вторичных конечных точек эффективности клинического исследования

### Подготовка данных и библиотек

```{r readr-second-endpoints}
# ITT-популяция, все пациенты
data <- read.csv("team5_ecrf_wide.csv", stringsAsFactors = TRUE)

data$ARM <- factor(data$ARM, levels = c("Angelique", "Climaksan"))

table(data$ARM)
 
# Проверка структуры данных
head(data[c("USUBJID","ARM","V0_SYM_FLASHES","V3_SYM_FLASHES","V7_SYM_FLASHES",
            "V0_SYM_GREENE","V3_SYM_GREENE","V7_SYM_GREENE",
            "V0_QOL_SF36","V3_QOL_SF36","V7_QOL_SF36")])
```

В данных используются обозначения визитов V0 (день 0, визит 1, базовый уровень), V3 (день 30, визит 3) и V7 (день 90, визит 7) и т.д. для соответствующих дней исследования.

Все анализы проводятся на ITT-популяции (все 100% рандомизированных пациентов, так как выбывших не было). Во всех тестах принят уровень значимости p \< 0.05.

### 1. Доля случаев \>=50% снижения частоты умеренных/тяжёлых приливов

На визите 3 (день 30) и визите 7 (день 90). Для каждого пациента создадим индикатор достижения снижения частоты приливов на \>=50% по сравнению с исходным уровнем и сравним доли между группами с помощью χ²-теста. Также рассчитаем отношение шансов с 95% доверительным интервалом.

```{r}

data$success50_day30 <- ifelse(data$V3_SYM_FLASHES <= 0.5 * data$V0_SYM_FLASHES, 1, 0)
data$success50_day90 <- ifelse(data$V7_SYM_FLASHES <= 0.5 * data$V0_SYM_FLASHES, 1, 0)
 
data$success50_day30 <- factor(data$success50_day30, levels = c(0,1), labels = c("No","Yes"))
data$success50_day90 <- factor(data$success50_day90, levels = c(0,1), labels = c("No","Yes"))

tab30 <- table(Group = data$ARM, "≥50% reduction Day30" = data$success50_day30)
tab90 <- table(Group = data$ARM, "≥50% reduction Day90" = data$success50_day90)
tab30; tab90  

chi30 <- chisq.test(tab30)   
chi90 <- chisq.test(tab90)   

chi30$p.value   
chi90$p.value   

model30 <- glm(success50_day30 ~ ARM, data = data, family = binomial)
model90 <- glm(success50_day90 ~ ARM, data = data, family = binomial)

OR_day30 <- exp(coef(model30)[2])  # OR на день 30 (Климаксан относительно Анжелик)
OR_day90 <- exp(coef(model90)[2])  # OR на день 90

OR_day30_CI <- exp(confint.default(model30)[2, ])  
OR_day90_CI <- exp(confint.default(model90)[2, ])   

cat(sprintf("Day 30: OR = %.2f, 95%% CI [%.2f; %.2f], p = %.4f\n",
            OR_day30, OR_day30_CI[1], OR_day30_CI[2], chi30$p.value))
cat(sprintf("Day 90: OR = %.2f, 95%% CI [%.2f; %.2f], p = %.4f\n",
            OR_day90, OR_day90_CI[1], OR_day90_CI[2], chi90$p.value))
```

Описательная статистика по доле достигших \>=50% снижение: сформируем таблицу с численностью и процентом пациентов, достигших эффекта, в каждой группе на 30-й и 90-й день.

```{r}
 
prop_stats <- data %>% group_by(ARM) %>%
  summarise(
    N = n(),
    n_success30 = sum(success50_day30 == "Yes"),
    perc_success30 = 100 * mean(success50_day30 == "Yes"),
    n_success90 = sum(success50_day90 == "Yes"),
    perc_success90 = 100 * mean(success50_day90 == "Yes")
  )

prop_stats <- prop_stats %>%
  mutate(
    Day30 = sprintf("%d (%.1f%%)", n_success30, perc_success30),
    Day90 = sprintf("%d (%.1f%%)", n_success90, perc_success90)
  ) %>%
  select(Группа = ARM, N, "≥50% снижение (День 30)" = Day30, "≥50% снижение (День 90)" = Day90)

ft_prop <- flextable(prop_stats)
ft_prop <- autofit(ft_prop)
ft_prop
```

### 2. Снижение суммы баллов по шкале Greene Climacteric Scale

На визите 3 (день 30) и визите 7 (день 90). Рассчитаем изменение общего балла шкалы Greene от исходного уровня (визит 1) до визитов 3 и 7. Сравнение изменений между группами проводим с помощью t-теста Уэлча (независимые выборки, дисперсии могут различаться). Статистическую значимость оцениваем при p \< 0.05.

```{r}
# (базовый балл минус балл на визите)  положительное значение означает снижение симптоматики
data$greene_change_30 <- data$V0_SYM_GREENE - data$V3_SYM_GREENE    
data$greene_change_90 <- data$V0_SYM_GREENE - data$V7_SYM_GREENE    

greene_stats <- data %>% group_by(ARM) %>%
  summarise(
    N = n(),
    mean_change30 = mean(greene_change_30, na.rm = TRUE),
    sd_change30   = sd(greene_change_30, na.rm = TRUE),
    mean_change90 = mean(greene_change_90, na.rm = TRUE),
    sd_change90   = sd(greene_change_90, na.rm = TRUE)
  )

greene_stats <- greene_stats %>%
  mutate(
    se_change30 = sd_change30 / sqrt(N),
    ci_lower30 = mean_change30 - 1.96 * se_change30,
    ci_upper30 = mean_change30 + 1.96 * se_change30,
    se_change90 = sd_change90 / sqrt(N),
    ci_lower90 = mean_change90 - 1.96 * se_change90,
    ci_upper90 = mean_change90 + 1.96 * se_change90
  )

greene_stats <- greene_stats %>%
  mutate(
    `Изм. Greene (день 30) mean±SD` = sprintf("%.2f ± %.2f", mean_change30, sd_change30),
    `95% ДИ (день 30)` = sprintf("[%.2f; %.2f]", ci_lower30, ci_upper30),
    `Изм. Greene (день 90) mean±SD` = sprintf("%.2f ± %.2f", mean_change90, sd_change90),
    `95% ДИ (день 90)` = sprintf("[%.2f; %.2f]", ci_lower90, ci_upper90)
  ) %>%
  select(Группа = ARM, N,
         `Изм. Greene (день 30) mean±SD`,
         `95% ДИ (день 30)`,
         `Изм. Greene (день 90) mean±SD`,
         `95% ДИ (день 90)`)

ft_greene <- flextable(greene_stats)
ft_greene <- autofit(ft_greene)
ft_greene
```

Теперь проведём t-тесты для сравнения изменений между группами:

```{r}

t_green30 <- t.test(greene_change_30 ~ ARM, data = data, var.equal = FALSE)
t_green90 <- t.test(greene_change_90 ~ ARM, data = data, var.equal = FALSE)

# День 30
t_green30
format.pval(t_green30$p.value, digits = 3, eps = 1e-16)

data %>%
  group_by(ARM) %>%
  summarise(
    n = sum(!is.na(greene_change_30)),
    mean = mean(greene_change_30, na.rm = TRUE),
    sd = sd(greene_change_30, na.rm = TRUE),
    .groups = "drop"
  )

m30_clim <- mean(data$greene_change_30[data$ARM == "Climaksan"], na.rm = TRUE)
m30_ang  <- mean(data$greene_change_30[data$ARM == "Angelique"], na.rm = TRUE)
sd30_clim <- sd(data$greene_change_30[data$ARM == "Climaksan"], na.rm = TRUE)
sd30_ang  <- sd(data$greene_change_30[data$ARM == "Angelique"], na.rm = TRUE)

cat(sprintf(
  "Изменение балла Greene к дню 30: p = %s (Климаксан: %.2f±%.2f, Анжелик: %.2f±%.2f)\n",
  format.pval(t_green30$p.value, digits = 3, eps = 1e-16),
  m30_clim, sd30_clim, m30_ang, sd30_ang
))

# День 90 
t_green90
format.pval(t_green90$p.value, digits = 3, eps = 1e-16)

data %>%
  group_by(ARM) %>%
  summarise(
    n = sum(!is.na(greene_change_90)),
    mean = mean(greene_change_90, na.rm = TRUE),
    sd = sd(greene_change_90, na.rm = TRUE),
    .groups = "drop"
  )

m90_clim <- mean(data$greene_change_90[data$ARM == "Climaksan"], na.rm = TRUE)
m90_ang  <- mean(data$greene_change_90[data$ARM == "Angelique"], na.rm = TRUE)
sd90_clim <- sd(data$greene_change_90[data$ARM == "Climaksan"], na.rm = TRUE)
sd90_ang  <- sd(data$greene_change_90[data$ARM == "Angelique"], na.rm = TRUE)

cat(sprintf(
  "Изменение балла Greene к дню 90: p = %s (Климаксан: %.2f±%.2f, Анжелик: %.2f±%.2f)\n",
  format.pval(t_green90$p.value, digits = 3, eps = 1e-16),
  m90_clim, sd90_clim, m90_ang, sd90_ang
))

```

### 3. Время до снижения количества приливов на 2 в сутки

Для оценки периода, необходимого для снижения числа приливов на 2 в день (по данным дневников), используем анализ времени до события. Событие определяем как первое появление значения "число приливов в сутки" на 2 меньше исходного уровня. Все пациенты, не достигшие снижения \>=2 приливов, цензурируются на последнем визите наблюдения (90 дней).

Применим метод Каплана-Мейера для построения кривых **времени до события** в каждой группе и логранговый тест для сравнения кривых.

```{r}

data$time_reduce2 <- NA  # время наступления события или цензуры
data$event_reduce2 <- 0  

# время события для каждого пациента
for(i in 1:nrow(data)) {
  bl <- data$V0_SYM_FLASHES[i]
  if (!is.na(bl)) {
    if (data$V2_SYM_FLASHES[i] <= bl - 2) {
      data$time_reduce2[i] <- 15
      data$event_reduce2[i] <- 1
    } else if (data$V3_SYM_FLASHES[i] <= bl - 2) {
      data$time_reduce2[i] <- 30
      data$event_reduce2[i] <- 1
    } else if (data$V4_SYM_FLASHES[i] <= bl - 2) {
      data$time_reduce2[i] <- 45
      data$event_reduce2[i] <- 1
    } else if (data$V5_SYM_FLASHES[i] <= bl - 2) {
      data$time_reduce2[i] <- 60
      data$event_reduce2[i] <- 1
    } else if (data$V6_SYM_FLASHES[i] <= bl - 2) {
      data$time_reduce2[i] <- 75
      data$event_reduce2[i] <- 1
    } else if (data$V7_SYM_FLASHES[i] <= bl - 2) {
      data$time_reduce2[i] <- 90
      data$event_reduce2[i] <- 1
    } else {
      # событие не произошло к 90 дню: цензурируем на 90 день
      data$time_reduce2[i] <- 90
      data$event_reduce2[i] <- 0
    }
  }
}

table(data$event_reduce2, data$ARM)  # распределение событий/цензуры по группам

# Анализ Каплана-Мейера
surv_obj <- Surv(time = data$time_reduce2, event = data$event_reduce2)
km_fit <- survfit(surv_obj ~ ARM, data = data)
print(km_fit)

# Логранговый тест для сравнения кривых выживания 
logrank_test <- survdiff(surv_obj ~ ARM, data = data)
logrank_test$chisq   
p_logrank <- 1 - pchisq(logrank_test$chisq, df = 1)  
p_logrank
cat(sprintf("Логранговый тест: χ² = %.2f, p = %.2e\n", logrank_test$chisq, p_logrank))

#  медиана времени до события в каждой группе (если >50% пациентов достигли событие)
medians <- quantile(km_fit, probs = 0.5)
medians

plot(km_fit, col=c("blue","red"), lty=1:2, xlab="Дни", ylab="Доля без снижения приливов на 2",
     main="Время до снижения количества приливов на 2 в сутки")
legend("bottomleft", legend = levels(data$ARM), col=c("blue","red"), lty=1:2)

```

На графике выше по оси y отложена доля пациентов, не достигших снижения количества приливов на 2. Кривые Каплана-Мейера показывают вероятность того, что событие ещё не произошло в зависимости от времени. Заметное расхождение кривых и полученное p-значение логрангового теста указывают на различие между группами.

### 4. Увеличение суммы баллов по шкале SF-36

На визите 3 (день 30) и визите 7 (день 90). Рассчитаем изменение общего балла SF-36 от исходного уровня: положительное изменение означает улучшение качества жизни. Сравним средние улучшения между группами с помощью t-теста Уэлча.

```{r}
 
data$sf36_change_30 <- data$V3_QOL_SF36 - data$V0_QOL_SF36   # изменение к дню 30 (увеличение)
data$sf36_change_90 <- data$V7_QOL_SF36 - data$V0_QOL_SF36   # изменение к дню 90

sf36_stats_raw <- data %>% 
  group_by(ARM) %>%
  summarise(
    N = sum(!is.na(sf36_change_30)),
    mean_change30 = mean(sf36_change_30, na.rm = TRUE),
    sd_change30   = sd(sf36_change_30, na.rm = TRUE),
    mean_change90 = mean(sf36_change_90, na.rm = TRUE),
    sd_change90   = sd(sf36_change_90, na.rm = TRUE),
    .groups = "drop"
  )

sf36_stats <- sf36_stats_raw %>%
  mutate(
    se_change30 = sd_change30 / sqrt(N),
    ci_lower30 = mean_change30 - 1.96 * se_change30,
    ci_upper30 = mean_change30 + 1.96 * se_change30,
    se_change90 = sd_change90 / sqrt(N),
    ci_lower90 = mean_change90 - 1.96 * se_change90,
    ci_upper90 = mean_change90 + 1.96 * se_change90
  ) %>%
  mutate(
    `Изм. SF-36 (день 30) mean±SD` = sprintf("%.2f ± %.2f", mean_change30, sd_change30),
    `95% ДИ (день 30)` = sprintf("[%.2f; %.2f]", ci_lower30, ci_upper30),
    `Изм. SF-36 (день 90) mean±SD` = sprintf("%.2f ± %.2f", mean_change90, sd_change90),
    `95% ДИ (день 90)` = sprintf("[%.2f; %.2f]", ci_lower90, ci_upper90)
  ) %>%
  select(Группа = ARM, N,
         `Изм. SF-36 (день 30) mean±SD`, `95% ДИ (день 30)`,
         `Изм. SF-36 (день 90) mean±SD`, `95% ДИ (день 90)`)

ft_sf36 <- flextable(sf36_stats)
ft_sf36 <- autofit(ft_sf36)
ft_sf36

t_sf30 <- t.test(sf36_change_30 ~ ARM, data = data, var.equal = FALSE)
t_sf90 <- t.test(sf36_change_90 ~ ARM, data = data, var.equal = FALSE)

t_sf30$p.value
t_sf90$p.value

m_clim <- sf36_stats_raw$mean_change30[sf36_stats_raw$ARM == "Climaksan"]
sd_clim <- sf36_stats_raw$sd_change30[sf36_stats_raw$ARM == "Climaksan"]
m_ang  <- sf36_stats_raw$mean_change30[sf36_stats_raw$ARM == "Angelique"]
sd_ang <- sf36_stats_raw$sd_change30[sf36_stats_raw$ARM == "Angelique"]

cat(sprintf(
  "Увеличение SF-36 к дню 30: p = %s (Климаксан: %.1f±%.1f, Анжелик: %.1f±%.1f)\n",
  format.pval(t_sf30$p.value, digits = 3, eps = 1e-16),
  m_clim, sd_clim, m_ang, sd_ang
))

```

# Раздел 4. Анализ безопасности

```{r AE-df}
not_ADAE <- data_raw %>% 
  select(USUBJID, ARM, contains("_ABN")) %>% 
  mutate(ARM = ARM %>% as.factor()) %>% 
  rename_with(~str_remove(.x, "_ABN"), contains("_ABN")) %>% 
  pivot_longer(!c(USUBJID, ARM),
               names_to = c("AVISIT", "DOMAIN", "PARAM"),
               names_sep = "_",
               names_transform = list(AVISIT = as.factor,
                                      DOMAIN = as.factor,
                                      PARAM = as.factor),
               values_to = "AVAL", 
               values_transform = list(AVAL = as.logical)) %>% 
  rename(TRTA = ARM) %>% 
  filter(AVISIT != "V0")
```

## 4.1 Анализ связи типа нежелательного явления и терапии

```{r}
any_AE <- not_ADAE %>% 
  group_by(USUBJID, TRTA, PARAM) %>% 
  summarise(AVAL = any(AVAL == TRUE)) %>% 
  ungroup()
```

```{r chi-sq-table-wide, eval=FALSE, echo=FALSE}
# {any_AE %>%
#   mutate(TRTA = case_when(TRTA == "Angelique" ~ "Анжелик",
#                           TRTA == "Climaksan" ~ "Климаксан") %>% as.factor,
#          PARAM = case_when(PARAM == "BP" ~ "Артериальное давление",
#                            PARAM == "HR" ~ "ЧСС",
#                            PARAM == "RR" ~ "ЧДД",
#                            PARAM == "TEMP" ~ "Температура",
#                            PARAM == "RHYTHM" ~ "Сердечный ритм",
#                            PARAM == "STT" ~ "Сегменты ST-T",
#                            PARAM == "QT" ~ "Интервал QT") %>% as.factor(),
#          AVAL = case_when(AVAL == TRUE ~ "Да",
#                           AVAL == FALSE ~ "Нет") %>% as.factor()) %>% 
#   select(-USUBJID) %>%
#   rename("Терапия" = TRTA) %>% 
#   tbl_strata(strata = PARAM, .tbl_fun = ~.x %>% 
#                tbl_summary(by = AVAL,
#                            statistic = c(all_categorical() ~ "{n} ({p})"),
#                            digits = c(all_categorical() ~ c(2,2))
#                            ) %>%
#                add_p(test = list(all_categorical() ~ "chisq.test"),
#                      test.args = list(correct = TRUE))  %>%
#                modify_footnote(
#                  p.value ~ "χ2 с поправкой Йейтса"
#                  ) %>%
#                modify_header(label ~ "Группа")) %>% 
#   as_flex_table() %>% 
#   flex_default_fun()} %>% 
#   add_header_row(values =  "Наличие клинически значимых отклонений по типам показателей и терапии", colwidths = length(.$col_keys))
```

```{r chi-sq-tb-long}
table_final_chi_sq <-
  {any_AE %>%
  mutate(
    TRTA = case_when(
      TRTA == "Angelique" ~ "Анжелик",
      TRTA == "Climaksan" ~ "Климаксан"
    ) %>% factor(),
    PARAM = case_when(
      PARAM == "BP" ~ "Артериальное давление",
      PARAM == "HR" ~ "ЧСС",
      PARAM == "RR" ~ "ЧДД",
      PARAM == "TEMP" ~ "Температура",
      PARAM == "RHYTHM" ~ "Сердечный ритм",
      PARAM == "STT" ~ "Сегменты ST-T",
      PARAM == "QT" ~ "Интервал QT",
    ) %>% factor(),
    AVAL = case_when(AVAL == TRUE ~ "Да",
                     AVAL == FALSE ~ "Нет") %>% factor()
  ) %>%
    pivot_wider(names_from = PARAM, values_from = AVAL) %>%
    rename("Терапия" = TRTA) %>%
    select(-USUBJID) %>%
    tbl_summary(
    by = `Терапия`,
    statistic = all_categorical() ~ "{n} ({p}%)",
    digits = all_categorical() ~ 1
      ) %>%
    add_p(
    test = all_categorical() ~ "chisq.test",
    test.args = all_tests("chisq.test") ~ list(correct = TRUE)
      ) %>%
    modify_header(label ~ "Параметр / Группа") %>%
    modify_footnote(p.value ~ "χ2 с поправкой Йейтса") %>%
    bold_labels() %>% 
  as_flex_table() %>% 
  flex_default_fun()} %>% 
  add_header_row(values =  "Наличие клинически значимых отклонений по типам показателей и терапии", colwidths = length(.$col_keys))
```

\newpage
**Сводная таблица по типам НЯ в зависимости от группы терапии**

```{r AE-type-table}
table_final_chi_sq
```

По результатам анализа мы не обнаружили значимой ассоциации НЯ различных типов с терапией.

## 4.2 Анализ количества НЯ по типу терапии

Используем регрессию Пуассона для частотных данных.

Формула модели:

$N_events ~ Pois(λ_x)$

$log(E(N_events | Treatment)) = log(λ_x)$

$var(N_events | Treatment) = λ_x$

$log(λ_x) = b_0 + b_1 × Treatment$

Допущения: 

    1) Независимость наблюдений;
    
    2) Отсутствие сверхдисперсии (проверяется далее);
    
    3) Отсутствие коллинеарности предикторов (у нас один предиктор, неприменимо).

```{r mod-pois}
poisson_df <- not_ADAE %>% 
  group_by(USUBJID, TRTA) %>% 
  summarise(AVAL_num = sum(AVAL, na.rm = TRUE)) %>% 
  ungroup()

glm_AE <- glm(AVAL_num ~ TRTA,
              data = poisson_df,
              family = "poisson")
```

**Проверка модели на сверхдисперсию**

```{r pois-overdisp}
# Функция для проверки наличия сверхдисперсии в модели (автор Ben Bolker)
# http://bbolker.github.io/mixedmodels-misc/glmmFAQ.html
# Код модифицирован, чтобы учесть дополнительный параметр в NegBin GLMM, 
# подобранных MASS::glm.nb()
overdisp_fun <- function(model) {
  rdf <- df.residual(model)  # Число степеней свободы N - p
  if (any(class(model) == 'negbin')) rdf <- rdf - 1 ## учитываем k в NegBin GLMM
  rp <- residuals(model,type='pearson') # Пирсоновские остатки
  Pearson.chisq <- sum(rp^2) # Сумма квадратов остатков, подчиняется Хи-квадрат распределению 
  prat <- Pearson.chisq/rdf  # Отношение суммы квадратов остатков к числу степеней свободы
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE) # Уровень значимости
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)        # Вывод результатов
}
{overdisp_fun(glm_AE)} %>% 
  tibble("Names" = names(.)) %>% 
  rename("Values" = ".") %>% 
  pivot_wider(names_from = Names, values_from = Values) %>% 
  mutate(across(c(where(is.numeric), -rdf), ~round(.x, 2))) %>% 
  rename("χ2" = chisq,
         "Отношение дисперсий" = ratio,
         "N степеней свободы" = rdf,
         "P-value" = p) %>% 
  flextable() %>% 
  flex_default_fun() %>% 
  add_header_row(values = "Результаты теста на сверхдисперсию", colwidth = 4)
```

Признаков сверхдисперсии не выявлено; в связи с этим переход к квази-пуассоновским или негативно биноминальным моделям не потребовался.

**Сводная таблица результатов анализа общей частоты нежелательных явлений в группах терапии с помощью регрессии Пуассона**

```{r pois-res}
{glm_AE %>% broom::tidy(exponentiate = TRUE,
                       conf.int = TRUE) %>%
     mutate(p.value = p.value %>%  gtsummary::style_pvalue(),
            across(c(where(is.numeric), - p.value), ~round(.x, 2))) %>% 
  slice_tail(n = 1) %>% 
  mutate(term = "Отношение частоты НЯ (IRR)") %>%
  select(-statistic) %>% 
  rename(
    `Показатель` = term,
    `Коэффициент (β)` = estimate,
    `Стандартная ошибка` = std.error,
    `P-value` = p.value,
    `Нижн. гр. 95% ДИ` = conf.low,
    `Верхн. гр. 95% ДИ` = conf.high
    ) %>% 
  flextable()} %>% 
  add_header_row(., values = "Отношение частоты НЯ в гр. терапии Климаксаном по сравнению с гр. терапии Анжеликом", colwidth = length(.$col_keys)) %>% 
  flex_default_fun()
```

По результатам анализа регрессионной модели нахождению коэффициента и 95%ДИ с помощью теста Вальда для показателя терапии, отношение частоты событий (IRR) при терапии Климаксаном по отношению к группе Анжеликом составляет 0.96 (95%ДИ [0.89 ; 1.04]), p-значение теста коэффициента составило 0.3. Данный 95%ДИ накрывает 1 и $p-value > 0.05$, следовательно, частота НЯ в группах различается не значимо.
