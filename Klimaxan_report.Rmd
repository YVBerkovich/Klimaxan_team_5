---
title: "Klimaxan_report"
authors: 
date: "2026-01-18"
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidyverse)
library(readxl)
library(readr)
library(flextable)

set_flextable_defaults(table.layout = "autofit",
                       font.family = "Times New Roman")

flex_default_fun <- function(x) {
  x %>% 
  theme_box() %>%
  font(fontname = "Times New Roman", part = "all") %>% 
  fontsize(size = 13, part = "header") %>% 
  fontsize(size = 12, part = "body") %>% 
  flextable::align(
  i = 1,
  j = NULL,
  align = "center",
  part = "header")
}

statistics <- list(
        "N valid" = ~round(sum(!is.na(.)), 2),
        # "Пропущенные значения, n" = ~round(sum(is.na(.)), 2),
        "Среднее" = ~round(mean(., na.rm = TRUE), 2),
        "Стандартное отклонение"   = ~round(sd(., na.rm = TRUE), 2),
        "Медиана" = ~round(median(., na.rm = TRUE), 2),
        "Q1" = ~round(quantile(., 0.25, na.rm = TRUE), 2),
        "Q3" = ~round(quantile(., 0.75, na.rm = TRUE), 2),
        "IQR" = ~round(IQR(., na.rm = TRUE), 2),
        "Мин"  = ~round(min(., na.rm = TRUE), 2),
        "Макс"  = ~round(max(., na.rm = TRUE), 2)
      )

```

```{r}
getwd()
```
```{r}
setwd("/Users/natalatimkina/Klimaxan_team_5")
```

```{r}
library(readr)
data_raw <- read_csv("team5_ecrf_wide.csv")
glimpse(data_raw)
```

``` {r data prep, echo=FALSE}

data_long <- data_raw %>%
  pivot_longer(
    cols = matches("^V[0-9]+_"),
    names_to = "var",
    values_to = "value"
  ) %>%
  mutate(
    visit = str_extract(var, "^V[0-9]+"),
    varname = str_remove(var, "^V[0-9]+_")
  )
glimpse(data_long)
```

```{r primary 1, echo=FALSE}
library(dplyr)
data_raw <- data_raw %>%
  mutate(delta_f = V0_SYM_FLASHES - V7_SYM_FLASHES)
```


```{r primary 2, echo=FALSE}
data_raw$ARM <- factor(data_raw$ARM, levels = c("Climaksan", "Angelique"))

desc_stats <- data_raw %>%
  group_by(ARM) %>%
  summarise(
    n = sum(!is.na(delta_f)),
    mean_delta = mean(delta_f, na.rm = TRUE),
    sd_delta = sd(delta_f, na.rm = TRUE),
    se_delta = sd_delta / sqrt(n),
    ci_lower = mean_delta - qt(0.975, n-1) * se_delta,
    ci_upper = mean_delta + qt(0.975, n-1) * se_delta,
    median_delta = median(delta_f, na.rm = TRUE),
    min_delta = min(delta_f, na.rm = TRUE),
    max_delta = max(delta_f, na.rm = TRUE)
  )

print(desc_stats)

non_inferiority_margin <- -2  
alpha <- 0.05  
conf_level <- 1 - alpha  

# Правильные формулировки гипотез:
# H0: μ_T - μ_R ≤ -2 (Климаксан УСТУПАЕТ Анжелику)
# H1: μ_T - μ_R > -2 (Климаксан НЕ УСТУПАЕТ Анжелику)


t_test_noninf <- t.test(delta_f ~ ARM, 
                       data = data_raw,  
                       var.equal = FALSE,
                       conf.level = conf_level,  
                       alternative = "greater",  
                       mu = non_inferiority_margin)  

cat("\n=== Результаты t-теста для проверки не меньшей эффективности ===\n")
cat(sprintf("Граница не меньшей эффективности (дельта): %.2f\n", non_inferiority_margin))
cat(sprintf("Статистика t: %.3f\n", t_test_noninf$statistic))
cat(sprintf("Степени свободы: %.2f\n", t_test_noninf$parameter))
cat(sprintf("Одностороннее p-значение: %.4f\n", t_test_noninf$p.value))
cat(sprintf("95%% односторонний ДИ: [%.3f, Inf]\n", t_test_noninf$conf.int[1]))
cat(sprintf("Разность средних (Климаксан - Анжелик): %.3f\n", 
            -diff(t_test_noninf$estimate)))  

mean_diff <- -diff(t_test_noninf$estimate)
se_diff <- sqrt(sum(desc_stats$sd_delta^2 / desc_stats$n))
df_welch <- t_test_noninf$parameter
margin <- qt(1 - alpha, df_welch) * se_diff
ci_lower_noninf <- mean_diff - margin

cat(sprintf("\nТочная оценка разности: %.3f\n", mean_diff))
cat(sprintf("95%% односторонний ДИ (нижняя граница): %.3f\n", ci_lower_noninf))

cat("\n=== Вывод о не меньшей эффективности ===\n")
if (t_test_noninf$p.value < alpha && ci_lower_noninf > non_inferiority_margin) {
  cat("ОТВЕРГАЕМ H0: Климаксан НЕ УСТУПАЕТ Анжелику.\n")
  cat(sprintf("Нижняя граница 95%% ДИ (%.3f) > границы не меньшей эффективности (%.2f)\n", 
              ci_lower_noninf, non_inferiority_margin))
} else {
  cat("НЕ ОТВЕРГАЕМ H0: Не удалось доказать не меньшую эффективность Климаксана.\n")
  cat(sprintf("Нижняя граница 95%% ДИ (%.3f) ≤ границе не меньшей эффективности (%.2f)\n", 
              ci_lower_noninf, non_inferiority_margin))
}

cat("\n=== Двусторонний t-тест Уэлча для общего сравнения ===\n")
t_test_welch <- t.test(delta_f ~ ARM, 
                      data = data_raw,
                      var.equal = FALSE,
                      conf.level = 0.95)
print(t_test_welch)
```


