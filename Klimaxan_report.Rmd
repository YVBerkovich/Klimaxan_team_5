---
title: "Klimaxan_report"
authors: 
date: "2026-01-18"
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidyverse)
library(readxl)
library(readr)
library(flextable)
library(ggplot2)

set_flextable_defaults(table.layout = "autofit",
                       font.family = "Times New Roman")

flex_default_fun <- function(x) {
  x %>% 
  theme_box() %>%
  font(fontname = "Times New Roman", part = "all") %>% 
  fontsize(size = 13, part = "header") %>% 
  fontsize(size = 12, part = "body") %>% 
  flextable::align(
  i = 1,
  j = NULL,
  align = "center",
  part = "header")
}

statistics <- list(
        "N valid" = ~round(sum(!is.na(.)), 2),
        # "Пропущенные значения, n" = ~round(sum(is.na(.)), 2),
        "Среднее" = ~round(mean(., na.rm = TRUE), 2),
        "Стандартное отклонение"   = ~round(sd(., na.rm = TRUE), 2),
        "Медиана" = ~round(median(., na.rm = TRUE), 2),
        "Q1" = ~round(quantile(., 0.25, na.rm = TRUE), 2),
        "Q3" = ~round(quantile(., 0.75, na.rm = TRUE), 2),
        "IQR" = ~round(IQR(., na.rm = TRUE), 2),
        "Мин"  = ~round(min(., na.rm = TRUE), 2),
        "Макс"  = ~round(max(., na.rm = TRUE), 2)
      )

```



```{r}
data_raw <- read_csv("team5_ecrf_wide.csv")
glimpse(data_raw)
```



``` {r data prep, echo=FALSE}
data_long <- data_raw %>%
  pivot_longer(
    cols = matches("^V[0-9]+_"),
    names_to = "var",
    values_to = "value"
  ) %>%
  mutate(
    visit = str_extract(var, "^V[0-9]+"),
    varname = str_remove(var, "^V[0-9]+_")
  )
glimpse(data_long)
```

Считаем уменьшение приливов к последнему визиту по сравнению с базовым уровнем.

```{r primary 1, echo=FALSE}
data_raw <- data_raw %>%
  mutate(delta_f = V0_SYM_FLASHES - V7_SYM_FLASHES)
```


*Сводная таблица *

```{r primary 2, echo=FALSE}
data_raw <- data_raw %>% 
  mutate(ARM = ARM %>% as.factor() %>% forcats::fct_rev())

desc_stats <- data_raw %>%
  group_by(ARM) %>%
  summarise(
    n = sum(!is.na(delta_f)),
    mean_delta = mean(delta_f, na.rm = TRUE),
    sd_delta = sd(delta_f, na.rm = TRUE),
    se_delta = sd_delta / sqrt(n),
    ci_lower = mean_delta - qt(0.975, n-1) * se_delta,
    ci_upper = mean_delta + qt(0.975, n-1) * se_delta,
    median_delta = median(delta_f, na.rm = TRUE),
    min_delta = min(delta_f, na.rm = TRUE),
    max_delta = max(delta_f, na.rm = TRUE)
  )

print(desc_stats)
```



```{r primary 2, echo=FALSE}
non_inferiority_margin <- -2  
alpha <- 0.05  
conf_level <- 1 - alpha  

# Правильные формулировки гипотез:
# H0: μ_T - μ_R ≤ -2 (Климаксан УСТУПАЕТ Анжелику)
# H1: μ_T - μ_R > -2 (Климаксан НЕ УСТУПАЕТ Анжелику)


t_test_noninf <- t.test(delta_f ~ ARM, 
                       data = data_raw,  
                       var.equal = FALSE,
                       conf.level = conf_level / 2,  
                       alternative = "greater",  
                       mu = non_inferiority_margin)  

cat("\n=== Результаты t-теста для проверки не меньшей эффективности ===\n")
cat(sprintf("Граница не меньшей эффективности (дельта): %.2f\n", non_inferiority_margin))
cat(sprintf("Статистика t: %.3f\n", t_test_noninf$statistic))
cat(sprintf("Степени свободы: %.2f\n", t_test_noninf$parameter))
cat(sprintf("Одностороннее p-значение: %.4f\n", t_test_noninf$p.value))
cat(sprintf("95%% односторонний ДИ: [%.3f, Inf]\n", t_test_noninf$conf.int[1]))
cat(sprintf("Разность средних (Климаксан - Анжелик): %.3f\n", 
            -diff(t_test_noninf$estimate)))  

mean_diff <- -diff(t_test_noninf$estimate)
se_diff <- sqrt(sum(desc_stats$sd_delta^2 / desc_stats$n))
df_welch <- t_test_noninf$parameter
margin <- qt(1 - alpha, df_welch) * se_diff
ci_lower_noninf <- mean_diff - margin

cat(sprintf("\nТочная оценка разности: %.3f\n", mean_diff))
cat(sprintf("97.5%% односторонний ДИ (нижняя граница): %.3f\n", ci_lower_noninf))

cat("\n=== Вывод о не меньшей эффективности ===\n")
if (t_test_noninf$p.value < alpha && ci_lower_noninf > non_inferiority_margin) {
  cat("ОТВЕРГАЕМ H0: Климаксан НЕ УСТУПАЕТ Анжелику.\n")
  cat(sprintf("Нижняя граница 95%% ДИ (%.3f) > границы не меньшей эффективности (%.2f)\n", 
              ci_lower_noninf, non_inferiority_margin))
} else {
  cat("НЕ ОТВЕРГАЕМ H0: Не удалось доказать не меньшую эффективность Климаксана.\n")
  cat(sprintf("Нижняя граница 95%% ДИ (%.3f) ≤ границе не меньшей эффективности (%.2f)\n", 
              ci_lower_noninf, non_inferiority_margin))
}
```



```{r primary 3, echo=FALSE}
cat("\n=== Двусторонний t-тест Уэлча для общего сравнения ===\n")
t_test_welch <- t.test(delta_f ~ ARM, 
                      data = data_raw,
                      var.equal = FALSE,
                      conf.level = 0.95)
t_test_welch %>% broom::tidy() %>% 
  mutate(p.value = p.value %>% gtsummary::style_pvalue()) %>%
  mutate(across(c(where(is.numeric), -p.value), ~round(.x, 2))) %>%
  mutate(across(everything(), ~as.character(.x))) %>% 
  select(-c(method, alternative)) %>% 
   rename(
    `Разница средних между гр. Климаксана и гр. Анжелика` = estimate,
    `Среднее в гр. Климаксана` = estimate1,
    `Среднее в гр. Анжелика` = estimate2,
    `t-статистика` = statistic,
    `Степени свободы` = parameter,
    `P-value` = p.value,
    `Нижн. гр. 95% ДИ` = conf.low,
    `Верхн. гр. 95% ДИ` = conf.high
  ) %>% 
  pivot_longer(everything(),
               names_to = "Параметр",
               values_to = "Значение") %>% 
  flextable() %>% 
  flex_default_fun() %>% 
  add_header_row(values = "Двусторонний t-тест Уэлча для общего сравнения",
                 colwidths = 2)
```


```{r primary 4, echo=FALSE}
density_plot <- ggplot(data_raw, aes(x = delta_f)) +
  geom_histogram(aes(y = after_stat(density), fill = ARM), 
                 alpha = 0.5, position = "identity", bins = 30) +
  geom_density(alpha = 0.3, aes(fill = ARM)) +
  geom_vline(data = desc_stats, aes(xintercept = mean_delta, color = ARM),
             linetype = "dashed", linewidth = 1) +
  facet_wrap(~ARM, ncol = 1) +
  scale_fill_manual(values = c("Climaksan" = "blue", "Angelique" = "red"),
                    labels = c("Climaksan" = "Климаксан", "Angelique" = "Анжелик")) +
  scale_color_manual(values = c("Climaksan" = "darkblue", "Angelique" = "darkred"),
                    labels = c("Climaksan" = "Климаксан", "Angelique" = "Анжелик")) +
  labs(title = "Распределение изменений частоты приливов",
       x = "Изменение частоты приливов (приливы/сутки)",
       y = "Плотность распределения",
       color = "Терапия",
       fill = "Терапия",
       caption = "Пунктирная линия = среднее значение") +
  theme_minimal() +
  theme(strip.text.x = element_blank())

print(density_plot)
```

```{r primary 5, echo=FALSE}
library(ggplot2)
library(dplyr)

# Подготовка данных для графика
plot_data <- data.frame(
  Comparison = "Климаксан vs Анжелик",
  Estimate = -3.236,
  CI_lower = -3.663,
  CI_upper = -2.809,
  Margin = -2,
  p_value = 1.000
)

# Создание графика
forest_plot <- ggplot(plot_data, aes(x = Estimate, y = Comparison)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_vline(xintercept = -2, linetype = "solid", color = "red", size = 1) +
  geom_point(size = 4, color = "blue") +
  geom_errorbarh(aes(xmin = CI_lower, xmax = CI_upper), 
                 height = 0.1, size = 1, color = "blue") +
  geom_rect(aes(xmin = -Inf, xmax = -2, ymin = -Inf, ymax = Inf),
            fill = "red", alpha = 0.05) +
  annotate("text", x = -2, y = 1.2, 
           label = "Граница не меньшей эффективности\n(-2 прилива/сутки)",
           hjust = 0.5, vjust = 0, color = "red", fontface = "bold") +
  annotate("text", x = -3.236, y = 0.7, 
           label = sprintf("Разность средних: %.3f\n95%% ДИ: [%.3f; %.3f]\nP = %.4f", 
                          -3.236, -3.663, -2.809, 1.000),
           hjust = 0.5, vjust = 0.5, color = "black") +
  scale_x_continuous(breaks = seq(-5, 1, 0.5),
                     limits = c(-5, 1),
                     name = "Разность средних (Климаксан - Анжелик)\nприливы/сутки") +
  labs(title = "Анализ не меньшей эффективности",
       subtitle = "Первичная конечная точка: изменение частоты приливов",
       y = "") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.title.x = element_text(size = 11, face = "bold"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )

print(forest_plot)
```
```{r sec-end-time}
calculate_time_to_reduction_fast <- function(data) {

  visit_days <- c(0, 15, 30, 45, 60, 75, 90)

  flash_cols <- c("V0_SYM_FLASHES", "V2_SYM_FLASHES", "V3_SYM_FLASHES", 
                  "V4_SYM_FLASHES", "V5_SYM_FLASHES", "V6_SYM_FLASHES", 
                  "V7_SYM_FLASHES")
  
  results <- data_raw %>%
    mutate(
      baseline = V0_SYM_FLASHES,
      target = baseline - 2,
      reduction_day = case_when(
        !is.na(V2_SYM_FLASHES) & V2_SYM_FLASHES <= target ~ 15,
        !is.na(V3_SYM_FLASHES) & V3_SYM_FLASHES <= target ~ 30,
        !is.na(V4_SYM_FLASHES) & V4_SYM_FLASHES <= target ~ 45,
        !is.na(V5_SYM_FLASHES) & V5_SYM_FLASHES <= target ~ 60,
        !is.na(V6_SYM_FLASHES) & V6_SYM_FLASHES <= target ~ 75,
        !is.na(V7_SYM_FLASHES) & V7_SYM_FLASHES <= target ~ 90,
        TRUE ~ NA_real_
      ),
      event_status = if_else(is.na(reduction_day), 0, 1),
      
      time_to_event = if_else(
        event_status == 1,
        reduction_day,
        90
      ),
      
      time_to_event = case_when(
        is.na(baseline) | baseline < 2 ~ NA_real_,
        event_status == 1 ~ reduction_day,
        TRUE ~ 90
      )
    ) %>%
    select(-c(target, reduction_day))
  
  return(results)
}

data_with_time <- calculate_time_to_reduction_fast(data_raw)
```

